<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Documentation Checklist</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12; /* Orange for skipped */
            --danger: #e74c3c;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
            --border: #e1e4e8;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --header-height: 80px;
            --input-bg: #fff;
        }

        /* DARK MODE VARIABLES */
        body.dark-mode {
            --primary: #ecf0f1;
            --accent: #5dade2;
            --bg: #1a1a1a;
            --card: #2c2c2c;
            --text: #e0e0e0;
            --border: #444;
            --input-bg: #333;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* Dark Mode Text Enhancements */
        body.dark-mode .card-label { color: #b0bec5 !important; }
        body.dark-mode ::placeholder { color: #aaa; opacity: 0.7; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { color: #fff; }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            /* Added extra padding for the save bar */
            padding-top: calc(var(--header-height) + 70px); 
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- STICKY PROGRESS DASHBOARD --- */
        .sticky-dashboard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            transition: background 0.3s, border 0.3s;
        }

        body.dark-mode .sticky-dashboard {
            background: rgba(44, 44, 44, 0.98);
        }

        /* --- SAVE SLOT BAR --- */
        .save-slot-bar {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between; 
            gap: 15px;
            border-bottom: 4px solid var(--accent);
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            z-index: 900;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-wrap: wrap;
        }

        .slot-controls-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
        }

        .save-slot-bar label { font-weight: bold; color: #ecf0f1; font-size: 0.9rem; }
        .save-slot-bar input {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            width: 220px;
            font-weight: bold;
            color: #2c3e50;
            font-family: monospace;
            font-size: 1rem;
            text-transform: uppercase;
        }
        
        .slot-btn {
            background: #34495e;
            color: white;
            border: 1px solid #455a64;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .slot-btn:hover { background: #2c3e50; }

        .btn-highlight {
            background: var(--accent);
            border-color: #2980b9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-highlight:hover { background: #2980b9; transform: translateY(-1px); }

        .dashboard-wrapper {
            width: 100%;
            max-width: 900px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .dashboard-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Print Icon in Sticky Header */
        .sticky-print-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sticky-print-btn:hover {
            transform: scale(1.1);
            background: var(--accent);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .current-action {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-indicator.active {
            background-color: var(--accent);
            box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
            animation: pulse 2s infinite;
        }

        .status-indicator.warning {
            background-color: var(--warning);
            animation: none;
        }

        .text-warning { color: #d35400; }
        body.dark-mode .text-warning { color: #e67e22; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        .progress-track {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        body.dark-mode .progress-track { background-color: #444; }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #2980b9);
            width: 0%;
            transition: width 0.4s ease, background-color 0.4s;
        }
        
        .progress-fill.complete { background: var(--success); }
        .progress-fill.has-skipped { background: var(--warning); }

        /* --- ANALYTICS DASHBOARD --- */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .analytics-grid { grid-template-columns: 1fr; }
        }

        .chart-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid var(--border);
        }

        .phase-bars-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .phase-bar-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .phase-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        body.dark-mode .phase-label { color: #ccc; }

        .mini-track {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            width: 100%;
            overflow: hidden;
        }
        body.dark-mode .mini-track { background: #444; }

        .mini-fill {
            height: 100%;
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Chart Colors */
        .fill-p1 { background: linear-gradient(to right, #4facfe, #00f2fe); }
        .fill-p2 { background: linear-gradient(to right, #43e97b, #38f9d7); }
        .fill-p3 { background: linear-gradient(to right, #fa709a, #fee140); }
        .fill-p4 { background: linear-gradient(to right, #667eea, #764ba2); }

        /* Donut Chart */
        .donut-chart {
            width: 120px;
            height: 120px;
            position: relative;
        }
        
        .donut-circle {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        .donut-bg { stroke: #eee; }
        body.dark-mode .donut-bg { stroke: #444; }

        .donut-val { 
            stroke: var(--accent); 
            stroke-dasharray: 283; /* 2 * PI * 45 */
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.8s ease;
        }

        .donut-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .donut-number { font-size: 1.5em; font-weight: bold; color: var(--primary); }
        .donut-label { font-size: 0.7em; color: #777; }
        body.dark-mode .donut-label { color: #aaa; }

        /* Countdown & Widgets */
        .widgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .widget-card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .widget-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            display: block;
        }
        body.dark-mode .widget-title { color: #ccc; }

        .countdown-display {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }
        body.dark-mode .countdown-display { background: #2c3e50; color: #fff; }
        
        .countdown-display.urgent { background: #ffebee; color: #c62828; }
        body.dark-mode .countdown-display.urgent { background: #5a1a1a; color: #ff9999; }

        /* Custom Task Widget */
        .custom-task-input {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .custom-task-input input {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text);
        }
        .add-task-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .custom-tasks-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 100px;
            overflow-y: auto;
        }
        .custom-task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px dashed var(--border);
            font-size: 0.9em;
        }
        .delete-task {
            color: var(--danger);
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }

        /* --- MAIN LAYOUT --- */
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .header-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        h1 {
            color: var(--primary);
            margin: 0;
            font-size: 1.8rem;
        }

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        .btn {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .btn:hover { background-color: #2c3e50; }
        .btn-secondary { background-color: var(--accent); }
        .btn-secondary:hover { background-color: #2980b9; }
        
        .btn-portable { 
            background: #8e44ad; 
            border: 2px solid #71368a;
        }
        .btn-portable:hover { background: #9b59b6; }

        .dark-toggle {
            background: #ffffff20;
            border: 2px solid #ffffff50;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .dark-toggle:hover { background: #ffffff40; }

        /* --- DATA ENTRY CARD --- */
        .details-card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid var(--primary);
            border: 1px solid var(--border);
        }

        .details-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: space-between; /* Adjusted for Reset Button */
            gap: 10px;
        }
        
        .reset-btn {
            font-size: 0.9rem;
            padding: 6px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .reset-btn:hover { background: #c0392b; }

        /* TYPE TOGGLE */
        .type-toggle-container {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        body.dark-mode .type-toggle-container { background-color: #333; border-color: #444; }

        .type-label {
            font-weight: bold;
            color: var(--primary);
            margin-right: 10px;
        }

        .type-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 16px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 20px;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--text);
        }

        .type-option:hover {
            border-color: var(--accent);
        }

        .type-option input[type="radio"] {
            accent-color: var(--accent);
            cursor: pointer;
        }

        .type-option.selected {
            border-color: var(--accent);
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--accent);
            font-weight: bold;
        }

        .invoice-status-bar {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 12px 15px;
            margin-top: 25px; /* Moved to bottom */
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        body.dark-mode .invoice-status-bar { background-color: #1e3a5f; border-color: #1565c0; }
        
        .invoice-status-bar label {
            font-weight: 700;
            color: #1565c0;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.05rem;
        }
        body.dark-mode .invoice-status-bar label { color: #90caf9; }

        /* Question mark logic */
        .q-mark {
            color: #e65100;
            font-weight: bold;
            margin-left: 2px;
        }
        
        #actual-invoice-status:checked ~ label .q-mark {
            display: none;
        }
        
        #actual-invoice-status:checked ~ label::after {
            content: " ‚úì";
            color: var(--success);
        }

        #actual-invoice-status:checked {
            accent-color: var(--success);
        }
        
        /* Change background when checked */
        .invoice-status-bar:has(#actual-invoice-status:checked) {
            background-color: #e8f5e9;
            border-color: #a5d6a7;
        }
        body.dark-mode .invoice-status-bar:has(#actual-invoice-status:checked) {
            background-color: #1b5e20;
            border-color: #2e7d32;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* NEW 4-COLUMN GRID FOR BOTTOM ROWS */
        .grid-row-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        /* Styling for the Commercial Row (Top) */
        .commercial-row {
            background-color: #f9f9f9;
            border: 1px solid #eee;
        }
        body.dark-mode .commercial-row { background-color: #333; border-color: #444; }

        /* Styling for the Actual Row (Bottom, Distinct Color) */
        .actual-row {
            background-color: #e0f7fa; /* Light Cyan/Blue */
            border: 1px solid #b2ebf2;
        }
        body.dark-mode .actual-row { background-color: #004d40; border-color: #00695c; }

        .section-label {
            grid-column: 1 / -1;
            font-size: 0.9em;
            font-weight: bold;
            color: #546e7a;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        body.dark-mode .section-label { color: #b0bec5; }

        .input-group {
            position: relative;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #7f8c8d;
            margin-bottom: 6px;
        }
        body.dark-mode .input-group label { color: #aab7b8; }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background-color: var(--input-bg);
            color: var(--text);
        }
        body.dark-mode .input-group input { border-color: #555; }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* --- PHASE CARDS --- */
        .phase-container {
            background: var(--card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s, opacity 0.3s, max-height 0.3s;
            opacity: 1;
            max-height: 2000px; /* Arbitrary large height for animation */
            border: 1px solid var(--border);
        }
        
        .phase-container.hidden {
            display: none; /* Force hide */
        }

        .phase-header {
            padding: 15px 25px;
            font-weight: 700;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .p1-head { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: #004660; }
        .p2-head { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: #005c4b; }
        .p3-head { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #6d2c00; }
        .p4-head { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        
        .phase-meta {
            font-size: 0.8em;
            background: rgba(255,255,255,0.3);
            padding: 4px 10px;
            border-radius: 20px;
        }

        /* --- STEPS & CHECKBOXES --- */
        .step-list { list-style: none; padding: 0; margin: 0; }

        .step-item {
            padding: 20px 25px;
            border-bottom: 1px solid #f1f1f1;
            transition: background 0.2s;
            border-left: 4px solid transparent; /* For highlighting skipped items */
        }
        body.dark-mode .step-item { border-bottom-color: #444; }
        
        /* Highlight Skipped Items */
        .step-item.skipped-item {
            background-color: #fff8e1;
            border-left-color: var(--warning);
        }
        body.dark-mode .step-item.skipped-item { background-color: #4e3800; }
        
        .step-item.skipped-item .step-title::after {
            content: ' (Skipped)';
            color: var(--warning);
            font-size: 0.8em;
            font-weight: bold;
        }

        .step-item:last-child { border-bottom: none; }
        .step-item:hover { background-color: #fafafa; }
        body.dark-mode .step-item:hover { background-color: #333; }
        .step-item.skipped-item:hover { background-color: #fff3e0; }
        body.dark-mode .step-item.skipped-item:hover { background-color: #5d4000; }

        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
        }

        /* Custom Checkbox */
        input[type="checkbox"] {
            appearance: none;
            min-width: 24px;
            height: 24px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            margin-right: 15px;
            margin-top: 2px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        input[type="checkbox"]:checked {
            background-color: var(--success);
            border-color: var(--success);
        }

        input[type="checkbox"]:checked::after {
            content: '‚úì';
            color: white;
            position: absolute;
            font-size: 16px;
            left: 5px;
            top: -1px;
        }

        /* Sub-Checkbox Style */
        .sub-checkbox-wrapper {
            margin-left: 42px; /* Align with text of parent */
            margin-top: 8px;
            margin-bottom: 8px;
            padding: 8px 12px;
            background-color: #fff8e1; /* Light orange/yellow background */
            border-radius: 6px;
            border-left: 3px solid #ffb74d;
            display: flex;
            align-items: flex-start;
        }
        body.dark-mode .sub-checkbox-wrapper { background-color: #4e3800; border-color: #ff9800; }
        
        .sub-checkbox-wrapper label {
            font-size: 0.9em;
            font-weight: 600;
            color: #e65100;
            cursor: pointer;
        }
        body.dark-mode .sub-checkbox-wrapper label { color: #ffb74d; }
        
        .sub-checkbox-wrapper input[type="checkbox"] {
            min-width: 18px;
            height: 18px;
            margin-right: 10px;
            border-color: #ffb74d;
            margin-top: 1px;
        }
        
        .sub-checkbox-wrapper input[type="checkbox"]:checked {
            background-color: #ffb74d;
            border-color: #ffb74d;
        }

        /* Completed Text Style */
        input[type="checkbox"]:checked + div .step-title,
        .sub-checkbox-wrapper input[type="checkbox"]:checked + label {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .step-title {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--primary);
            transition: color 0.2s;
        }

        .step-detail {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 5px;
            line-height: 1.5;
        }
        body.dark-mode .step-detail { color: #aaa; }

        /* --- EMAIL TEMPLATES --- */
        .email-template {
            background-color: #f8f9fa;
            border-left: 4px solid var(--accent);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
            margin-left: 40px; /* Align with text not checkbox */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.03);
            color: #333; /* Keep email text readable */
        }
        body.dark-mode .email-template { background-color: #e0e0e0; border-color: #3498db; }

        .whatsapp-template {
            background-color: #e3fcec;
            border-left: 4px solid #25d366;
        }
        body.dark-mode .whatsapp-template { background-color: #dcf8c6; border-color: #25d366; }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: white;
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .copy-btn:hover {
            background-color: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .highlight-var {
            background-color: #fffde7;
            padding: 2px 5px;
            border-radius: 3px;
            border-bottom: 2px solid #fdd835;
            font-weight: bold;
            color: #333;
        }

        /* --- TOGGLE SWITCH FOR FORWARDER --- */
        .forwarder-select {
            background-color: #f3f0ff;
            padding: 15px 25px;
            border-bottom: 1px solid #e1dced;
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* allow wrapping on mobile */
            gap: 20px;
        }
        body.dark-mode .forwarder-select { background-color: #333; border-color: #444; }
        
        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 20px;
            background: var(--card);
            border: 1px solid transparent;
            transition: all 0.2s;
            color: var(--text);
        }

        .radio-label:hover { border-color: var(--accent); }
        .radio-label input:checked + span { font-weight: bold; color: var(--accent); }

        /* MANUAL FORWARDER STYLES */
        .manual-options {
            background-color: #fff;
            border: 2px dashed #b39ddb;
            padding: 15px;
            margin: 10px 25px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        body.dark-mode .manual-options { background-color: #333; border-color: #7e57c2; }

        .manual-options input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 200px;
            background-color: var(--input-bg);
            color: var(--text);
        }
        
        .manual-method-group {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.9em;
        }

        .hidden { display: none !important; }
        .tag-urgent { color: #e74c3c; font-weight: bold; background: #fadbd8; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }

        /* --- OVERVIEW DASHBOARD STYLES --- */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .shipment-card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .shipment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: var(--accent);
        }

        .delete-shipment-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 5;
        }
        .delete-shipment-btn:hover { color: var(--danger); }

        .card-header {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 15px;
            padding-right: 30px; /* Space for delete btn */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .card-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        .track-link {
            text-decoration: none;
            color: var(--accent);
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 5px;
        }
        .track-link:hover { text-decoration: underline; }

        .card-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            background: #eee;
            font-size: 0.8rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            align-self: flex-start;
        }
        body.dark-mode .card-badge { background: #444; color: #ccc; }

        .status-complete { background: #d4edda; color: #155724; }
        .status-progress { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }

        .card-progress-track {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        body.dark-mode .card-progress-track { background: #444; }

        .card-progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            border-radius: 4px;
        }

        .card-meta {
            font-size: 0.8rem;
            color: #bdc3c7;
            margin-top: auto;
            margin-bottom: 10px;
            text-align: right;
        }

        .load-shipment-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
            margin-top: 10px;
        }
        .load-shipment-btn:hover { background: var(--accent); }

        .overview-title {
            text-align: center;
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        body.dark-mode .overview-title { border-bottom-color: #444; }

        /* NEW DASHBOARD CONTROLS STYLE */
        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .dashboard-controls input, .dashboard-controls select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text);
            flex-grow: 1;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .stat-card h3 { margin: 0 0 5px 0; color: #7f8c8d; font-size: 0.9rem; }
        .stat-card span { font-size: 1.8rem; font-weight: bold; color: var(--primary); }

        .dashboard-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        /* --- PRINT STYLES --- */
        @media print {
            .sticky-dashboard, .save-slot-bar, .print-btn, .copy-btn, .reset-btn, .type-toggle-container, .forwarder-select, .manual-options, .btn-group, .add-task-btn, .delete-task, .dark-toggle, .btn, .sticky-print-btn, #overview-container {
                display: none !important;
            }
            body { padding-top: 0; background: white; color: black; }
            .container { max-width: 100%; padding: 0; }
            .details-card, .phase-container, .widget-card, .chart-card {
                box-shadow: none; border: 1px solid #ccc; break-inside: avoid; background: white; color: black;
            }
            .phase-header { color: black !important; background: #eee !important; -webkit-print-color-adjust: exact; }
            .sub-checkbox-wrapper { background: none; border-left: 1px solid #ccc; }
            /* Force show checked items nicely */
            input[type=checkbox]:checked + div .step-title { text-decoration: none; color: black; font-weight: bold; }
            /* Hide empty inputs */
            input[type="text"], textarea { border: none; padding: 0; font-weight: bold; background: white; color: black; }
            .section-label { color: black; border-bottom: 1px solid black; }
        }
    </style>
</head>
<body>

    <!-- STICKY DASHBOARD -->
    <div class="sticky-dashboard">
        <div class="dashboard-wrapper">
            <div class="dashboard-content">
                <div class="status-row">
                    <div class="current-action" id="status-text">
                        <span class="status-indicator active"></span>
                        <span>Ready to start</span>
                    </div>
                    <div id="progress-percent">0%</div>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>
            </div>
            <!-- PRINT BUTTON ON RIGHT -->
            <button class="sticky-print-btn" onclick="window.print()" title="Print Checklist">üñ®Ô∏è</button>
        </div>
    </div>

    <!-- SAVE SLOT BAR (FIXED TOP) -->
    <div class="save-slot-bar">
        <div class="slot-controls-group">
            <label>üìÇ Shipment ID:</label>
            <input type="text" id="current-slot-id" list="slot-history" placeholder="e.g. INV-500" value="ALL" onfocus="this.value=''">
            <datalist id="slot-history">
                <!-- Populated by JS -->
            </datalist>
            <button class="slot-btn" onclick="loadSlot()">üîÑ Load</button>
            <button class="slot-btn btn-highlight" onclick="goToOverview()">üè† Overview</button>
        </div>
        <button class="dark-toggle" onclick="toggleDarkMode()">üåô Theme</button>
    </div>

    <!-- OVERVIEW DASHBOARD (Hidden by Default) -->
    <div id="overview-container" class="container hidden" style="max-width: 1100px;">
        <h1 class="overview-title">üì¶ All Shipments Overview</h1>
        
        <!-- Summary Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <h3>Total Shipments</h3>
                <span id="stat-total">0</span>
            </div>
            <div class="stat-card">
                <h3>Completed</h3>
                <span id="stat-completed" style="color: var(--success)">0</span>
            </div>
            <div class="stat-card">
                <h3>Pending</h3>
                <span id="stat-pending" style="color: var(--warning)">0</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="dashboard-controls">
            <input type="text" id="dash-search" placeholder="üîç Search Invoice, Customer, Container, Loading Date or ETA..." onkeyup="renderDashboard()">
            <select id="dash-sort" onchange="renderDashboard()">
                <option value="lastUpdated">üìÖ Sort by Last Updated</option>
                <option value="loadingDate">üöö Sort by Loading Date (Soonest)</option>
                <option value="etaDate">‚öì Sort by ETA (Soonest)</option>
                <option value="progressDesc">üìä Sort by Progress (High to Low)</option>
                <option value="progressAsc">üìä Sort by Progress (Low to High)</option>
                <option value="name">üî§ Sort by Name (A-Z)</option>
            </select>
        </div>

        <div class="dashboard-actions">
            <button class="btn btn-portable" onclick="savePortable()">üíæ Save Portable File (Backup)</button>
            <button class="btn btn-secondary" onclick="exportAllData()">üíæ Export All Data (JSON)</button>
            <button class="btn btn-secondary" onclick="triggerDashboardImport()">üìÇ Import Data (JSON)</button>
            <input type="file" id="dashboard-file-input" style="display:none" onchange="importAllData(this)">
        </div>

        <div id="overview-grid" class="overview-grid">
            <!-- Cards will be injected here -->
        </div>
    </div>

    <!-- MAIN CHECKLIST CONTAINER -->
    <div id="checklist-container" class="container">
        <div class="header-actions">
            <h1>Shipment Checklist</h1>
            <div class="btn-group">
                <!-- Theme toggle moved to top bar -->
                <button class="btn btn-secondary" onclick="printDeclaration()">üñ®Ô∏è Print Declaration</button>
                <button class="btn btn-secondary" onclick="printUndertaking()">üñ®Ô∏è Print Undertaking</button>
                <button class="btn btn-secondary" onclick="printShoesUndertaking()">üñ®Ô∏è Print Shoes Undertaking</button>
            </div>
        </div>

        <!-- ANALYTICS & WIDGETS SECTION -->
        <div class="analytics-grid">
            <div class="chart-card">
                <div class="donut-chart">
                    <svg viewBox="0 0 100 100" class="donut-svg">
                        <circle cx="50" cy="50" r="45" class="donut-circle donut-bg"></circle>
                        <circle cx="50" cy="50" r="45" class="donut-circle donut-val" id="donut-fill"></circle>
                    </svg>
                    <div class="donut-text">
                        <div class="donut-number" id="donut-num">0%</div>
                        <div class="donut-label">Done</div>
                    </div>
                </div>
            </div>
            <div class="chart-card">
                <div class="phase-bars-container">
                    <div class="phase-bar-group" id="stats-p1">
                        <div class="phase-label"><span>Phase 1: Inspection Req</span> <span id="p1-val">0%</span></div>
                        <div class="mini-track"><div class="mini-fill fill-p1" id="p1-bar"></div></div>
                    </div>
                    <div class="phase-bar-group" id="stats-p2">
                        <div class="phase-label"><span>Phase 2: Fumigation/SGS</span> <span id="p2-val">0%</span></div>
                        <div class="mini-track"><div class="mini-fill fill-p2" id="p2-bar"></div></div>
                    </div>
                    <div class="phase-bar-group" id="stats-p3">
                        <div class="phase-label"><span>Phase 3: COC</span> <span id="p3-val">0%</span></div>
                        <div class="mini-track"><div class="mini-fill fill-p3" id="p3-bar"></div></div>
                    </div>
                    <div class="phase-bar-group" id="stats-p4">
                        <div class="phase-label"><span>Final Phase: Forwarder/BL</span> <span id="p4-val">0%</span></div>
                        <div class="mini-track"><div class="mini-fill fill-p4" id="p4-bar"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="widgets-grid">
            <!-- WIDGET 1: COUNTDOWN -->
            <div class="widget-card" id="widget-countdown">
                <span class="widget-title">‚è≥ Inspection Countdown</span>
                <div class="countdown-display" id="countdown-timer">Set Inspection Date</div>
            </div>
            
            <!-- WIDGET 2: CUSTOM TASKS -->
            <div class="widget-card">
                <span class="widget-title">‚úÖ Custom Tasks</span>
                <div class="custom-task-input">
                    <input type="text" id="new-task-text" placeholder="Add custom task...">
                    <button class="add-task-btn" onclick="addCustomTask()">Add</button>
                </div>
                <ul id="custom-tasks-list" class="custom-tasks-list">
                    <!-- Tasks go here -->
                </ul>
            </div>
        </div>

        <!-- DATA ENTRY SECTION -->
        <div class="details-card">
            <div class="details-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    üìù Shipment Details
                </div>
                <button onclick="resetForm()" class="reset-btn">Reset All</button>
            </div>

            <!-- SHIPMENT TYPE TOGGLE -->
            <div class="type-toggle-container">
                <span class="type-label">Shipment Type:</span>
                <label class="type-option selected" id="opt-with-insp">
                    <input type="radio" name="shipment-type" value="with-inspection" checked onchange="toggleShipmentType()">
                    With Inspection
                </label>
                <label class="type-option" id="opt-no-insp">
                    <input type="radio" name="shipment-type" value="no-inspection" onchange="toggleShipmentType()">
                    Without Inspection
                </label>
            </div>

            <!-- MAIN GRID FOR STANDARD DETAILS -->
            <div class="input-grid">
                <!-- Row 1 -->
                <div class="input-group">
                    <label>Customer Name</label>
                    <input type="text" id="inp-customer" placeholder="Mr. Kazim">
                </div>
                <div class="input-group">
                    <label>Consignee Name</label>
                    <input type="text" id="inp-consignee" placeholder="Abuzar Enterprises">
                </div>
                <div class="input-group">
                    <label>Location</label>
                    <input type="text" id="inp-location" placeholder="Kenya">
                </div>
                <div class="input-group">
                    <label>Brand</label>
                    <input type="text" id="inp-brand" placeholder="White Tiger">
                </div>
                
                <!-- Row 2 -->
                <div class="input-group" id="grp-inspection-date">
                    <label>Inspection / Loading Date</label>
                    <input type="text" id="inp-date" placeholder="DD-MONTH-YYYY" oninput="updateVars(); updateCountdown();">
                </div>
                <div class="input-group">
                    <label>ETA (Est. Arrival)</label>
                    <input type="text" id="inp-eta" placeholder="DD-MONTH-YYYY">
                </div>
                <div class="input-group" id="grp-idf">
                    <label>IDF Number (with part mentioned)</label>
                    <input type="text" id="inp-idf" placeholder="25MBAIMxxxxxxxxxx / XX" oninput="updateVars()">
                </div>
                <div class="input-group" id="grp-seal">
                    <label>Seal Number (if available)</label>
                    <input type="text" id="inp-seal" placeholder="HLCxxxxxx">
                </div>
                <div class="input-group" id="grp-ucr">
                    <label>UCR Number</label>
                    <input type="text" id="inp-ucr" placeholder="25PKPxxxxxxxxxx" oninput="updateVars()">
                </div>
                
                <!-- Row 3 -->
                <div class="input-group">
                    <label>Proforma Invoice #</label>
                    <input type="text" id="inp-proforma" placeholder="e.g., ID-01-25" oninput="updateVars()">
                </div>
                <div class="input-group">
                    <label>Commercial Invoice #</label>
                    <input type="text" id="inp-invoice" placeholder="IRG-FE-xxx" oninput="updateVars()">
                </div>
                <div class="input-group">
                    <label>Container Number</label>
                    <input type="text" id="inp-container" placeholder="CAAUxxxxxxx" oninput="updateVars()">
                </div>
                <div class="input-group">
                    <label>Booking Number</label>
                    <input type="text" id="inp-booking" placeholder="EBKGxxxxxxxx" oninput="updateVars()">
                </div>
            </div>

            <!-- COMMERCIAL DETAILS ROW (4 items in a row) -->
            <div class="grid-row-4 commercial-row">
                <div class="section-label">Commercial Details</div>
                <div class="input-group">
                    <label>Commercial Invoice #</label>
                    <input type="text" id="inp-invoice" placeholder="IRG-FE-xxx" oninput="updateVars()">
                </div>
                <div class="input-group">
                    <label>Commercial Qty</label>
                    <input type="text" id="inp-com-qty" placeholder="e.g., 500 Bales">
                </div>
                <div class="input-group">
                    <label>Commercial Net Weight</label>
                    <input type="text" id="inp-com-nw" placeholder="e.g., 25000 KGS">
                </div>
                <div class="input-group">
                    <label>Commercial Gross Weight</label>
                    <input type="text" id="inp-com-gw" placeholder="e.g., 25100 KGS">
                </div>
            </div>

            <!-- ACTUAL DETAILS ROW (4 items in a row, distinctive color) -->
            <div class="grid-row-4 actual-row">
                <div class="section-label">Actual Details (Loaded)</div>
                <div class="input-group">
                    <label>Actual Invoice #</label>
                    <input type="text" id="inp-act-invoice" placeholder="e.g., IRG-FE-xxx">
                </div>
                <div class="input-group">
                    <label>Actual Qty Loaded</label>
                    <input type="text" id="inp-act-qty" placeholder="e.g., 500 Bales">
                </div>
                <div class="input-group">
                    <label>Actual Net Weight</label>
                    <input type="text" id="inp-act-nw" placeholder="e.g., 25000 KGS">
                </div>
                <div class="input-group">
                    <label>Actual Gross Weight</label>
                    <input type="text" id="inp-act-gw" placeholder="e.g., 25100 KGS">
                </div>
            </div>

            <!-- ACTUAL INVOICE STATUS -->
            <div class="invoice-status-bar">
                <input type="checkbox" id="actual-invoice-status">
                <label for="actual-invoice-status">Actual Commercial Invoice Sent to Customer<span class="q-mark">?</span></label>
            </div>
        </div>

        <!-- PHASE 1 (Inspection) -->
        <div class="phase-container" id="phase-1">
            <div class="phase-header p1-head">
                PHASE 1: SGS Inspection Request
                <span class="phase-meta">üìÖ BOOK INSPECTION MINIMUM 1 DAY BEFORE LOADING</span>
            </div>
            <ul class="step-list">
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p1-docs">
                        <div>
                            <label for="p1-docs" class="step-title">Prepare Documents (Part of Shipment)</label>
                            <div class="step-detail"> Ensure you have: IDF, then make Proforma Invoice, RFC & Declaration</div>
                        </div>
                    </div>
                </li>
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p1-mail">
                        <div>
                            <label for="p1-mail" class="step-title">Send Inspection Request Email</label>
                        </div>
                    </div>
                    <!-- SUB CHECKPOINT -->
                    <div class="sub-checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p1-attachments">
                        <label for="p1-attachments">Confirm Attachments: RFC, Declaration, IDF & Proforma</label>
                    </div>
                    
                    <div class="email-template">
                        <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                        <strong>To:</strong> Fazila.Shaikh@sgs.com<br>
                        <strong>CC:</strong> Saqib.Qadeer@sgs.com, export@amrags.com, Muhammad.ShoaibSiddiqui@sgs.com, Syed.Mahboob@sgs.com, imp-exp@amrags.com<br>
                        <strong>Subject:</strong> IDEAS RECYCLING (PVT) LTD, <span class="highlight-var var-idf">IDF-NUMBER</span> - <span class="highlight-var var-proforma">PROFORMA-NUM</span> - <span class="highlight-var var-consignee">CONSIGNEE</span> - INSPECTION REQ - <span class="highlight-var var-date">DATE</span><br><br>
                        Dear Saqib/Fazila,<br><br>
                        Please see attached Documents, kindly arrange inspection for <span class="highlight-var var-date">DATE</span>.<br>
                        Attached - RFC, declaration, IDF & Proforma Invoice.
                    </div>
                </li>
                <!-- MOVED FROM PHASE 2 -->
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p1-fumigation-booking">
                        <div>
                            <label for="p1-fumigation-booking" class="step-title">Book Fumigation (WhatsApp)</label>
                            <div class="step-detail">Contact: HASSAN SKY FUMIGATION (03332990665)</div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <!-- PHASE 2 (Fumigation & Post-Inspection) -->
        <div class="phase-container" id="phase-2">
            <div class="phase-header p2-head">
                PHASE 2: Fumigation & Post-Inspection
                <span class="phase-meta">üêõ Docs & SGS Reply</span>
            </div>
            <ul class="step-list">
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p2-mail">
                        <div>
                            <label for="p2-mail" class="step-title">Send Fumigation Documents Email</label>
                            <div class="step-detail">Attach: Commercial Invoice, Packing List</div>
                        </div>
                    </div>
                    <!-- SUB CHECKPOINT -->
                    <div class="sub-checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p2-attachments">
                        <label for="p2-attachments">Confirm Attachments: Commercial Invoice & Packing List</label>
                    </div>

                    <div class="email-template">
                        <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                        <strong>To:</strong> skyservices2k19@gmail.com<br>
                        <strong>Subject:</strong> INV <span class="highlight-var var-invoice">INV-NUM</span> Commercial Invoice and Packing List Attached For Fumigation Certificate<br><br>
                        Dear Sky Services Team,<br><br>
                        Please find attached the Commercial Invoice and Packing List for our recent shipment (Ref: Inv: <span class="highlight-var var-invoice">INV-NUM</span>, Container: <span class="highlight-var var-container">CONT-NUM</span>).<br><br>
                        Kindly review these documents. Once reviewed, please send over the official Payment Invoice and the Certificate of Fumigation at your earliest convenience so we can finalize processing and payment.
                    </div>
                </li>

                <!-- MOVED FROM PHASE 3A -->
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p3a-docs">
                        <div>
                            <label for="p3a-docs" class="step-title">Reply to SGS Inspection Thread</label>
                            <div class="step-detail"><span class="tag-urgent">CRITICAL</span> Mention "PART OF SHIPMENT" in body.</div>
                        </div>
                    </div>
                    <!-- SUB CHECKPOINT -->
                    <div class="sub-checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p3a-attachments">
                        <label for="p3a-attachments">Confirm Attachments: Health Cert, Fumigation Cert, CI, PL, Declaration of Origin, Used Clothing & Shoes Undertakings.</label>
                    </div>

                    <div class="email-template">
                        <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                        <strong>Note:</strong> Reply to the original SGS inspection email.<br><br>
                        Dear Saqib/Fazila,<br><br>
                        Please see attached documents, and send payment invoice and COC Draft.
                    </div>
                </li>
            </ul>
        </div>

        <!-- PHASE 3 (COC) -->
        <div class="phase-container" id="phase-3b">
            <div class="phase-header p3-head">
                PHASE 3: COC Finalization
                <span class="phase-meta">‚úÖ Cert. of Conformity</span>
            </div>
            <ul class="step-list">
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p3b-draft">
                        <div>
                            <label for="p3b-draft" class="step-title">Receive & Verify Draft</label>
                            <div class="step-detail">Receive Draft from SGS. Send to Customer for verification.</div>
                        </div>
                    </div>
                </li>
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p3b-pay">
                        <div>
                            <label for="p3b-pay" class="step-title">Process SGS Payment</label>
                            <div class="step-detail">Make payment via NR and save receipt photo.</div>
                        </div>
                    </div>
                </li>
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p3b-confirm">
                        <div>
                            <label for="p3b-confirm" class="step-title">Request Final COC</label>
                            <div class="step-detail">Reply to SGS with Payment Proof. Confirm Draft is approved.</div>
                        </div>
                    </div>
                    <!-- SUB CHECKPOINT -->
                    <div class="sub-checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p3b-attachments">
                        <label for="p3b-attachments">Confirm Attachments: Payment Receipt & Payment Invoice</label>
                    </div>

                    <div class="email-template">
                        <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                        <strong>Note:</strong> Reply to the SGS email containing the draft.<br><br>
                        Dear Fazila/Saqib,<br><br>
                        I am writing to confirm that the COC draft has been confirmed.<br><br>
                        Please find the payment proof attached to this email, and send the final COC Certificate.
                    </div>
                </li>
            </ul>
        </div>

        <!-- FINAL PHASE (BL - Always Visible) -->
        <div class="phase-container" id="phase-4">
            <div class="phase-header p4-head">
                FINAL PHASE: BL Process
                <span class="phase-meta">üö¢ Forwarder</span>
            </div>
            
            <div class="forwarder-select">
                <span>Forwarder:</span>
                <label class="radio-label">
                    <input type="radio" name="forwarder" value="xpo" checked onchange="toggleForwarder()"> 
                    <span>XPO (Email)</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="forwarder" value="hmi" onchange="toggleForwarder()"> 
                    <span>HMI (WhatsApp)</span>
                </label>
                <!-- NEW MANUAL OPTION -->
                <label class="radio-label">
                    <input type="radio" name="forwarder" value="manual" onchange="toggleForwarder()">
                    <span>Other (Manual)</span>
                </label>
            </div>

            <!-- MANUAL INPUTS (Hidden by default) -->
            <div id="manual-forwarder-options" class="manual-options hidden">
                <input type="text" id="manual-fwd-name" placeholder="Enter Forwarder Name" oninput="updateManualName()">
                
                <div class="manual-method-group">
                    <span>Method:</span>
                    <label class="radio-label">
                        <input type="radio" name="manual-method" value="email" checked onchange="toggleForwarder()"> Email
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="manual-method" value="whatsapp" onchange="toggleForwarder()"> WhatsApp
                    </label>
                </div>
            </div>

            <ul class="step-list">
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p4-draft">
                        <div>
                            <label for="p4-draft" class="step-title">Prepare BL Draft</label>
                            <div class="step-detail">Create Word File Draft after export is loaded.</div>
                        </div>
                    </div>
                </li>

                <!-- XPO Section -->
                <div id="xpo-section" class="forwarder-group">
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-mail-xpo">
                            <div>
                                <label for="p4-mail-xpo" class="step-title">Send Draft to XPO</label>
                            </div>
                        </div>
                        <!-- SUB CHECKPOINT -->
                        <div class="sub-checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-attachments-xpo">
                            <label for="p4-attachments-xpo">Confirm Attachments: BL Draft (Word File)</label>
                        </div>

                        <div class="email-template">
                            <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                            <strong>To:</strong> docs@xml.com.pk<br>
                            <strong>CC:</strong> export@amrags.com, imp-exp@amrags.com<br>
                            <strong>Subject:</strong> Draft Bill of Lading (BL) Attached - <span class="highlight-var var-container">CONT-NUM</span> - <span class="highlight-var var-invoice">INV-NUM</span><br><br>
                            Good Day,<br><br>
                            Please find attached the draft Bill of Lading (BL).<br>
                            Against Container Number - <span class="highlight-var var-container">CONT-NUM</span><br>
                            Booking Number - <span class="highlight-var var-booking">BOOK-NUM</span>
                        </div>
                    </li>
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-final-xpo">
                            <div>
                                <label for="p4-final-xpo" class="step-title">Draft BL Approved (Email)</label>
                                <div class="step-detail">Once customer approves, reply to Forwarder.</div>
                            </div>
                        </div>
                        <div class="email-template">
                            <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                            <strong>Reply Body:</strong><br><br>
                            We have reviewed the draft Bill of Lading (BL) for container <span class="highlight-var var-container">CONT-NUM</span>, BOOKING NUMBER - <span class="highlight-var var-booking">BOOK-NUM</span>.<br>
                            Please proceed with the finalization.
                        </div>
                    </li>
                </div>

                <!-- HMI Section -->
                <div id="hmi-section" class="forwarder-group hidden">
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-whatsapp-hmi">
                            <div>
                                <label for="p4-whatsapp-hmi" class="step-title">Send Draft to HMI (WhatsApp)</label>
                                <div class="step-detail">Send Word File Draft on WhatsApp.</div>
                                <div class="email-template whatsapp-template">
                                    <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                                    <strong>WhatsApp Message:</strong><br>
                                    Assalam o Alaikum,<br>
                                    Please find attached the draft Bill of Lading (BL).<br>
                                    Container: <span class="highlight-var var-container">CONT-NUM</span><br>
                                    BOOKING NUMBER: <span class="highlight-var var-booking">BOOK-NUM</span>
                                </div>
                            </div>
                        </div>
                        <!-- SUB CHECKPOINT -->
                        <div class="sub-checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-attachments-hmi">
                            <label for="p4-attachments-hmi">Confirm Attachments: BL Draft (Word File)</label>
                        </div>
                    </li>
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-final-hmi">
                            <div>
                                <label for="p4-final-hmi" class="step-title">Draft BL Approved (WhatsApp)</label>
                                <div class="step-detail">Message HMI upon approval.</div>
                            </div>
                        </div>
                        <div class="email-template whatsapp-template">
                            <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                            <strong>WhatsApp Message:</strong><br>
                            Draft BL approved for container <span class="highlight-var var-container">CONT-NUM</span>.<br>
                            BOOKING NUMBER: <span class="highlight-var var-booking">BOOK-NUM</span><br>
                            Please proceed with final.
                        </div>
                    </li>
                </div>

                <!-- MANUAL EMAIL SECTION -->
                <div id="manual-email-section" class="forwarder-group hidden">
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-mail-manual">
                            <div>
                                <label for="p4-mail-manual" class="step-title">Send Draft to <span class="manual-name-display">Forwarder</span> (Email)</label>
                            </div>
                        </div>
                        <!-- SUB CHECKPOINT -->
                        <div class="sub-checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-attachments-manual-email">
                            <label for="p4-attachments-manual-email">Confirm Attachments: BL Draft (Word File)</label>
                        </div>

                        <div class="email-template">
                            <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                            <strong>To:</strong> [Enter Email Address]<br>
                            <strong>Subject:</strong> Draft Bill of Lading (BL) Attached - <span class="highlight-var var-container">CONT-NUM</span> - <span class="highlight-var var-invoice">INV-NUM</span><br><br>
                            Good Day,<br><br>
                            Please find attached the draft Bill of Lading (BL).<br>
                            Against Container Number - <span class="highlight-var var-container">CONT-NUM</span><br>
                            Booking Number - <span class="highlight-var var-booking">BOOK-NUM</span>
                        </div>
                    </li>
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-final-manual-email">
                            <div>
                                <label for="p4-final-manual-email" class="step-title">Draft BL Approved (Email)</label>
                                <div class="step-detail">Once customer approves, reply to <span class="manual-name-display">Forwarder</span>.</div>
                            </div>
                        </div>
                        <div class="email-template">
                            <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                            <strong>Reply Body:</strong><br><br>
                            We have reviewed the draft Bill of Lading (BL) for container <span class="highlight-var var-container">CONT-NUM</span>, BOOKING NUMBER - <span class="highlight-var var-booking">BOOK-NUM</span>.<br>
                            Please proceed with the finalization.
                        </div>
                    </li>
                </div>

                <!-- MANUAL WHATSAPP SECTION -->
                <div id="manual-whatsapp-section" class="forwarder-group hidden">
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-whatsapp-manual">
                            <div>
                                <label for="p4-whatsapp-manual" class="step-title">Send Draft to <span class="manual-name-display">Forwarder</span> (WhatsApp)</label>
                                <div class="step-detail">Send Word File Draft on WhatsApp.</div>
                                <div class="email-template whatsapp-template">
                                    <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                                    <strong>WhatsApp Message:</strong><br>
                                    Assalam o Alaikum,<br>
                                    Please find attached the draft Bill of Lading (BL).<br>
                                    Container: <span class="highlight-var var-container">CONT-NUM</span><br>
                                    BOOKING NUMBER: <span class="highlight-var var-booking">BOOK-NUM</span>
                                </div>
                            </div>
                        </div>
                        <!-- SUB CHECKPOINT -->
                        <div class="sub-checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-attachments-manual-wa">
                            <label for="p4-attachments-manual-wa">Confirm Attachments: BL Draft (Word File)</label>
                        </div>
                    </li>
                    <li class="step-item">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="task-check" id="p4-final-manual-wa">
                            <div>
                                <label for="p4-final-manual-wa" class="step-title">Draft BL Approved (WhatsApp)</label>
                                <div class="step-detail">Message <span class="manual-name-display">Forwarder</span> upon approval.</div>
                            </div>
                        </div>
                        <div class="email-template whatsapp-template">
                            <button class="copy-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                            <strong>WhatsApp Message:</strong><br>
                            Draft BL approved for container <span class="highlight-var var-container">CONT-NUM</span>.<br>
                            BOOKING NUMBER: <span class="highlight-var var-booking">BOOK-NUM</span><br>
                            Please proceed with final.
                        </div>
                    </li>
                </div>

                <!-- Common Final Steps -->
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p4-received">
                        <div>
                            <label for="p4-received" class="step-title">Final BL / Seaway Received</label>
                            <div class="step-detail">Confirm receipt of the final documents.</div>
                        </div>
                    </div>
                </li>
                <li class="step-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="task-check" id="p3b-send">
                        <div>
                            <label for="p3b-send" class="step-title">Send Final Docs to Customer</label>
                            <div class="step-detail">
                                (After payment received confirmation)<br>
                                <strong>Attach:</strong> Final COC, CI, PL, Fumigation Cert, Seaway/BL.
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Hidden element to store data in the portable file -->
    <script id="embedded-db" type="application/json"></script>

    <script>
        // --- ROBUST STORAGE SYSTEM ---
        let CURRENT_SLOT = 'ALL'; // Default to Overview
        
        function getStoragePrefix(slot = CURRENT_SLOT) {
            return 'shipment_manager_v2_' + slot + '_';
        }

        // Initialize logic on load
        document.addEventListener('DOMContentLoaded', () => {
            // Check for embedded data (Portable File Mode)
            checkEmbedded();

            // ALWAYS START AT OVERVIEW DASHBOARD
            CURRENT_SLOT = 'ALL'; 
            document.getElementById('current-slot-id').value = "ALL";

            // Populate Datalist with all existing slots
            populateSlotSuggestions();

            loadSlot();
            
            // Generic Input Save Listener (Text & Textarea)
            document.querySelectorAll('input, textarea').forEach(input => {
                if(input.type === 'file' || input.id === 'current-slot-id' || input.id === 'dash-search') return;
                input.addEventListener('input', saveData);
                input.addEventListener('change', saveData);
            });
            
            document.querySelectorAll('input[name="shipment-type"]').forEach(el => {
                el.addEventListener('change', toggleShipmentType);
            });
            document.querySelectorAll('input[name="forwarder"]').forEach(el => {
                el.addEventListener('change', toggleForwarder);
            });
            document.querySelectorAll('input[name="manual-method"]').forEach(el => {
                el.addEventListener('change', toggleForwarder);
            });
            document.querySelectorAll('.task-check').forEach(box => {
                box.addEventListener('change', updateProgress);
            });
        });

        // --- NEW HELPER: POPULATE DATALIST ---
        function populateSlotSuggestions() {
            const datalist = document.getElementById('slot-history');
            datalist.innerHTML = ''; // Clear
            
            const slots = new Set();
            const prefix = 'shipment_manager_v2_';

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    const parts = key.split('_');
                    if (parts.length >= 4) {
                        const slotName = parts[3]; 
                        if (slotName !== 'undefined' && slotName !== 'null' && slotName !== 'ALL') {
                            slots.add(slotName);
                        }
                    }
                }
            }
            
            const sorted = Array.from(slots).sort();
            sorted.forEach(slot => {
                const option = document.createElement('option');
                option.value = slot;
                datalist.appendChild(option);
            });
        }

        function goToOverview() {
            document.getElementById('current-slot-id').value = "ALL";
            loadSlot();
        }

        // --- PORTABLE FILE LOGIC ---
        function savePortable() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('shipment_manager_v2_') || key === 'shipment_manager_last_slot') {
                    allData[key] = localStorage.getItem(key);
                }
            }
            const dataStr = JSON.stringify(allData);

            let htmlContent = document.documentElement.outerHTML;
            const scriptRegex = /<script id="embedded-db" type="application\/json">(.*?)<\/script>/s;
            const newScriptTag = `<script id="embedded-db" type="application/json">${dataStr}<\/script>`;
            
            if (scriptRegex.test(htmlContent)) {
                htmlContent = htmlContent.replace(scriptRegex, newScriptTag);
            } else {
                htmlContent = htmlContent.replace('</body>', `${newScriptTag}</body>`);
            }

            const blob = new Blob([htmlContent], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Shipment_Checklist_Portable.html";
            a.click();
        }

        function exportAllData() {
            const allData = {};
            const prefix = 'shipment_manager_v2_';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix) || key === 'shipment_manager_last_slot') {
                    allData[key] = localStorage.getItem(key);
                }
            }
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shipments_backup_all.json`;
            a.click();
        }

        function triggerDashboardImport() {
            document.getElementById('dashboard-file-input').click();
        }

        function importAllData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const keys = Object.keys(data);
                    const hasPrefix = keys.some(k => k.startsWith('shipment_manager_v2_'));
                    
                    if (!hasPrefix && keys.length > 0) {
                        alert("Error: This JSON file doesn't look like a bulk backup. It might be an old single-shipment export.");
                        return;
                    }

                    if(confirm(`Found ${keys.length} data items. This will merge with your current data. Continue?`)) {
                        keys.forEach(k => localStorage.setItem(k, data[k]));
                        alert("Data imported successfully!");
                        populateSlotSuggestions();
                        renderDashboard();
                    }
                } catch(err) {
                    alert('Error parsing JSON: ' + err);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function checkEmbedded() {
            const el = document.getElementById('embedded-db');
            if (el && el.textContent.trim()) {
                try {
                    const data = JSON.parse(el.textContent);
                    Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                    console.log("Restored data from embedded storage.");
                    alert("Portable data loaded successfully!");
                } catch(e) {
                    console.error("Failed to load embedded data", e);
                }
            }
        }

        // --- SLOT MANAGEMENT & OVERVIEW ---
        function loadSlot() {
            let newSlot = document.getElementById('current-slot-id').value.trim().toUpperCase();
            
            // If blank, force ALL
            if(!newSlot) {
                newSlot = "ALL";
                document.getElementById('current-slot-id').value = "ALL";
            }
            
            if (CURRENT_SLOT !== 'ALL' && CURRENT_SLOT !== newSlot) {
                saveData();
                populateSlotSuggestions(); // Update dropdown with new slot name if created
            }

            CURRENT_SLOT = newSlot;
            localStorage.setItem('shipment_manager_last_slot', CURRENT_SLOT);
            
            const dashboard = document.getElementById('overview-container');
            const checklist = document.getElementById('checklist-container');
            const stickyDash = document.querySelector('.sticky-dashboard');

            if (CURRENT_SLOT === 'ALL') {
                dashboard.classList.remove('hidden');
                checklist.classList.add('hidden');
                stickyDash.classList.add('hidden');
                renderDashboard();
            } else {
                dashboard.classList.add('hidden');
                checklist.classList.remove('hidden');
                stickyDash.classList.remove('hidden');
                resetVisuals();
                loadData();
            }
            
            // Re-check theme on load
            if(localStorage.getItem('shipment_theme_global') === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        // Helper to convert DD-MONTH-YYYY to Date object
        function parseDateString(dateStr) {
            if(!dateStr) return 0;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return 0;
            
            const day = parseInt(parts[0]);
            const monthStr = parts[1].toLowerCase();
            const year = parseInt(parts[2]);
            
            const months = { 'january': 0, 'jan': 0, 'february': 1, 'feb': 1, 'march': 2, 'mar': 2, 'april': 3, 'apr': 3, 'may': 4, 'june': 5, 'jun': 5, 'july': 6, 'jul': 6, 'august': 7, 'aug': 7, 'september': 8, 'sep': 8, 'sept': 8, 'october': 9, 'oct': 9, 'november': 10, 'nov': 10, 'december': 11, 'dec': 11 };
            
            const monthIndex = months[monthStr];
            if (monthIndex === undefined) return 0;
            
            return new Date(year, monthIndex, day).getTime();
        }

        // Relative time helper
        function timeAgo(ms) {
            if (!ms) return 'Never';
            const sec = Math.floor((Date.now() - ms) / 1000);
            if (sec < 60) return 'Just now';
            const min = Math.floor(sec / 60);
            if (min < 60) return min + 'm ago';
            const hr = Math.floor(min / 60);
            if (hr < 24) return hr + 'h ago';
            const day = Math.floor(hr / 24);
            if (day < 30) return day + 'd ago';
            return new Date(ms).toLocaleDateString();
        }

        function renderDashboard() {
            const grid = document.getElementById('overview-grid');
            grid.innerHTML = ''; 

            const slots = new Set();
            const prefix = 'shipment_manager_v2_';

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    const parts = key.split('_');
                    if (parts.length >= 4) {
                        const slotName = parts[3]; 
                        if (slotName !== 'undefined' && slotName !== 'null' && slotName !== 'ALL') {
                            slots.add(slotName);
                        }
                    }
                }
            }

            if (slots.size === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#7f8c8d; padding:40px;">No saved shipments found. Type a new ID above (e.g. INV-101) and click "Load" to start.</div>';
                updateStats(0, 0, 0);
                return;
            }

            let sortedSlots = Array.from(slots);
            
            // Prepare Data for Sort/Search
            let cardData = sortedSlots.map(slot => {
                const metaKey = getStoragePrefix(slot) + 'meta';
                const metaJson = localStorage.getItem(metaKey);
                let meta = { percent: 0, status: 'No status yet', lastUpdated: 0 };
                try { if(metaJson) meta = JSON.parse(metaJson); } catch(e){}
                
                const customer = localStorage.getItem(getStoragePrefix(slot) + 'inp-customer') || 'Unknown Customer';
                const container = localStorage.getItem(getStoragePrefix(slot) + 'inp-container') || 'No Container';
                const loadDate = localStorage.getItem(getStoragePrefix(slot) + 'inp-date') || '';
                const etaDate = localStorage.getItem(getStoragePrefix(slot) + 'inp-eta') || '';
                
                return { slot, meta, customer, container, loadDate, etaDate };
            });

            // 1. FILTER
            const searchVal = document.getElementById('dash-search').value.toLowerCase();
            if (searchVal) {
                cardData = cardData.filter(item => 
                    item.slot.toLowerCase().includes(searchVal) || 
                    item.customer.toLowerCase().includes(searchVal) ||
                    item.container.toLowerCase().includes(searchVal) ||
                    item.loadDate.toLowerCase().includes(searchVal) ||
                    item.etaDate.toLowerCase().includes(searchVal)
                );
            }

            // 2. SORT
            const sortVal = document.getElementById('dash-sort').value;
            cardData.sort((a, b) => {
                if (sortVal === 'lastUpdated') return b.meta.lastUpdated - a.meta.lastUpdated;
                if (sortVal === 'progressDesc') return b.meta.percent - a.meta.percent;
                if (sortVal === 'progressAsc') return a.meta.percent - b.meta.percent;
                if (sortVal === 'name') return a.slot.localeCompare(b.slot);
                
                // Date Sorting
                if (sortVal === 'loadingDate') {
                    const timeA = parseDateString(a.loadDate) || 9999999999999; // Push empty dates to end
                    const timeB = parseDateString(b.loadDate) || 9999999999999;
                    return timeA - timeB;
                }
                if (sortVal === 'etaDate') {
                    const timeA = parseDateString(a.etaDate) || 9999999999999;
                    const timeB = parseDateString(b.etaDate) || 9999999999999;
                    return timeA - timeB;
                }
                
                return 0;
            });

            // 3. STATS
            const total = cardData.length;
            const completed = cardData.filter(i => i.meta.percent === 100).length;
            const pending = total - completed;
            updateStats(total, completed, pending);

            // 4. RENDER
            cardData.forEach(item => {
                // Determine badge class
                let badgeClass = 'status-progress';
                if (item.meta.percent === 100) badgeClass = 'status-complete';
                else if (item.meta.status.includes('Skipped')) badgeClass = 'status-error';

                // Determine progress color
                let progressColor = 'var(--accent)';
                if (item.meta.percent === 100) progressColor = 'var(--success)';
                else if (item.meta.percent < 30) progressColor = '#e74c3c';
                else if (item.meta.percent < 70) progressColor = '#f39c12';

                // Track link logic
                const trackingLink = item.container && item.container.length > 4 
                    ? `<a href="https://www.track-trace.com/container/list/${item.container}" target="_blank" class="track-link" title="Track Container">üõ∞Ô∏è Track</a>` 
                    : '';

                const card = document.createElement('div');
                card.className = 'shipment-card';
                card.innerHTML = `
                    <button class="delete-shipment-btn" onclick="deleteShipment('${item.slot}')" title="Delete Shipment">üóëÔ∏è</button>
                    <div class="card-header">
                        <span>üì¶ ${item.slot}</span>
                        <span style="font-size:0.8em; color:${progressColor}">${item.meta.percent}%</span>
                    </div>
                    <div class="card-info-row">
                        <span class="card-label">Customer:</span>
                        <span style="font-weight:600">${item.customer}</span>
                    </div>
                    <div class="card-info-row">
                        <span class="card-label">Container:</span>
                        <span style="font-weight:600">${item.container} ${trackingLink}</span>
                    </div>
                    <div class="card-info-row">
                        <span class="card-label">Loading:</span>
                        <span style="font-weight:600">${item.loadDate || '-'}</span>
                    </div>
                    <div class="card-info-row">
                        <span class="card-label">ETA:</span>
                        <span style="font-weight:600">${item.etaDate || '-'}</span>
                    </div>
                    <div class="card-progress-track">
                        <div class="card-progress-fill" style="width: ${item.meta.percent}%; background:${progressColor}"></div>
                    </div>
                    <div class="card-badge ${badgeClass}">${item.meta.status}</div>
                    <div class="card-meta">Updated ${timeAgo(item.meta.lastUpdated)}</div>
                    <button class="load-shipment-btn" onclick="openShipment('${item.slot}')">Open Shipment</button>
                `;
                grid.appendChild(card);
            });
        }

        function updateStats(t, c, p) {
            document.getElementById('stat-total').innerText = t;
            document.getElementById('stat-completed').innerText = c;
            document.getElementById('stat-pending').innerText = p;
        }

        window.openShipment = function(slot) {
            document.getElementById('current-slot-id').value = slot;
            loadSlot();
        };

        window.deleteShipment = function(slot) {
            if(confirm(`Are you sure you want to PERMANENTLY DELETE shipment "${slot}"? This cannot be undone.`)) {
                const prefix = getStoragePrefix(slot);
                // Collect keys to remove
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(prefix)) {
                        keysToRemove.push(key);
                    }
                }
                // Remove keys
                keysToRemove.forEach(key => localStorage.removeItem(key));
                // Refresh dashboard & Datalist
                populateSlotSuggestions();
                renderDashboard();
            }
        };

        function resetVisuals() {
             // Reset text inputs & textareas
             document.querySelectorAll('input[type="text"], textarea').forEach(input => {
                if(input.id !== 'current-slot-id' && input.id !== 'dash-search') input.value = '';
             });
             document.querySelectorAll('input[type="checkbox"]').forEach(box => box.checked = false);
             document.getElementById('custom-tasks-list').innerHTML = '';
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        function saveData() {
            if (CURRENT_SLOT === 'ALL') return; 

            const PREFIX = getStoragePrefix();

            // Save Text Inputs & Textareas
            document.querySelectorAll('input[type="text"], textarea').forEach(input => {
                if(input.id !== 'current-slot-id' && input.id !== 'dash-search') { 
                    localStorage.setItem(PREFIX + input.id, input.value);
                }
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                localStorage.setItem(PREFIX + box.id, box.checked);
            });

            const radios = ['shipment-type', 'forwarder', 'manual-method'];
            radios.forEach(name => {
                const selected = document.querySelector(`input[name="${name}"]:checked`);
                if (selected) {
                    localStorage.setItem(PREFIX + name, selected.value);
                }
            });
            
            const tasks = [];
            document.querySelectorAll('.custom-task-item').forEach(item => {
                const text = item.querySelector('span').innerText;
                const isChecked = item.querySelector('input').checked;
                tasks.push({ text, isChecked });
            });
            localStorage.setItem(PREFIX + 'custom_tasks', JSON.stringify(tasks));
            
            updateVars();
            updateManualName();
            updateProgress(); 
            updateCountdown();
        }
        
        function loadData() {
            const PREFIX = getStoragePrefix();

            // Load Text Inputs & Textareas
            document.querySelectorAll('input[type="text"], textarea').forEach(input => {
                if(input.id !== 'current-slot-id' && input.id !== 'dash-search') {
                    const val = localStorage.getItem(PREFIX + input.id);
                    if (val) input.value = val;
                }
            });

            document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                const val = localStorage.getItem(PREFIX + box.id);
                if (val === 'true') box.checked = true;
                else box.checked = false;
            });

            const radios = ['shipment-type', 'forwarder', 'manual-method'];
            radios.forEach(name => {
                const val = localStorage.getItem(PREFIX + name);
                if (val) {
                    const radio = document.querySelector(`input[name="${name}"][value="${val}"]`);
                    if (radio) radio.checked = true;
                }
            });
            
            const savedTasks = localStorage.getItem(PREFIX + 'custom_tasks');
            if (savedTasks) {
                const tasks = JSON.parse(savedTasks);
                const list = document.getElementById('custom-tasks-list');
                list.innerHTML = '';
                tasks.forEach(task => {
                    renderTask(task.text, task.isChecked);
                });
            }

            updateVars();
            updateManualName();
            toggleShipmentType();
            toggleForwarder(); 
            updateCountdown();

            if(localStorage.getItem('shipment_theme_global') === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        // --- UTILITY FUNCTIONS ---
        function resetForm() {
            if(!confirm("Are you sure you want to reset data for " + CURRENT_SLOT + "?")) return;
            const PREFIX = getStoragePrefix();
            
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith(PREFIX)) {
                    localStorage.removeItem(key);
                }
            });

            resetVisuals();
            
            const inspRadio = document.querySelector('input[name="shipment-type"][value="with-inspection"]');
            if(inspRadio) inspRadio.checked = true;
            toggleShipmentType();
            
            const fwdRadio = document.querySelector('input[name="forwarder"][value="xpo"]');
            if(fwdRadio) fwdRadio.checked = true;
            toggleForwarder();

            updateVars();
            updateProgress();
            updateCountdown();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('shipment_theme_global', isDark ? 'dark' : 'light');
        }

        // Renamed old export to prevent confusion, although new exportAllData covers everything now.
        // function exportData() ... REMOVED

        // function triggerImport() ... REMOVED (Replaced by triggerDashboardImport)

        // function importData(input) ... REMOVED (Replaced by importAllData)

        function addCustomTask() {
            const input = document.getElementById('new-task-text');
            const text = input.value.trim();
            if (!text) return;
            renderTask(text, false);
            input.value = '';
            saveData();
        }
        function renderTask(text, isChecked) {
            const list = document.getElementById('custom-tasks-list');
            const li = document.createElement('li');
            li.className = 'custom-task-item';
            li.innerHTML = `<div style="display:flex; align-items:center;"><input type="checkbox" ${isChecked ? 'checked' : ''} onchange="saveData()"><span style="${isChecked ? 'text-decoration:line-through; opacity:0.6;' : ''}">${text}</span></div><span class="delete-task" onclick="removeTask(this)">√ó</span>`;
            const checkbox = li.querySelector('input');
            checkbox.addEventListener('change', function() {
                const span = this.nextElementSibling;
                span.style.textDecoration = this.checked ? 'line-through' : 'none';
                span.style.opacity = this.checked ? '0.6' : '1';
                saveData();
            });
            list.appendChild(li);
        }
        function removeTask(el) { el.parentElement.remove(); saveData(); }

        function toggleShipmentType() {
            const isInspection = document.querySelector('input[name="shipment-type"][value="with-inspection"]').checked;
            const phases = ['phase-1', 'phase-2', 'phase-3b'];
            const inspectionInputs = ['grp-inspection-date', 'grp-idf', 'grp-seal', 'grp-ucr'];
            const countdownWidget = document.getElementById('widget-countdown');
            const p1Stats = document.getElementById('stats-p1');
            const p2Stats = document.getElementById('stats-p2');
            const p3Stats = document.getElementById('stats-p3');
            const optWith = document.getElementById('opt-with-insp');
            const optNo = document.getElementById('opt-no-insp');
            
            if (isInspection) {
                optWith.classList.add('selected'); optNo.classList.remove('selected');
                phases.forEach(id => document.getElementById(id).classList.remove('hidden'));
                inspectionInputs.forEach(id => document.getElementById(id).classList.remove('hidden'));
                countdownWidget.classList.remove('hidden'); p1Stats.classList.remove('hidden'); p2Stats.classList.remove('hidden'); p3Stats.classList.remove('hidden');
            } else {
                optWith.classList.remove('selected'); optNo.classList.add('selected');
                phases.forEach(id => document.getElementById(id).classList.add('hidden'));
                inspectionInputs.forEach(id => document.getElementById(id).classList.add('hidden'));
                countdownWidget.classList.add('hidden'); p1Stats.classList.add('hidden'); p2Stats.classList.add('hidden'); p3Stats.classList.add('hidden');
            }
            updateProgress();
        }

        function toggleForwarder() {
            const xpoSection = document.getElementById('xpo-section');
            const hmiSection = document.getElementById('hmi-section');
            const manualOptions = document.getElementById('manual-forwarder-options');
            const manualEmailSection = document.getElementById('manual-email-section');
            const manualWaSection = document.getElementById('manual-whatsapp-section');
            
            const selectedRadio = document.querySelector('input[name="forwarder"]:checked');
            const selected = selectedRadio ? selectedRadio.value : 'xpo';
            
            xpoSection.classList.add('hidden'); hmiSection.classList.add('hidden'); manualOptions.classList.add('hidden'); manualEmailSection.classList.add('hidden'); manualWaSection.classList.add('hidden');
            
            if (selected === 'xpo') { xpoSection.classList.remove('hidden'); }
            else if (selected === 'hmi') { hmiSection.classList.remove('hidden'); }
            else if (selected === 'manual') {
                manualOptions.classList.remove('hidden');
                const methodRadio = document.querySelector('input[name="manual-method"]:checked');
                const method = methodRadio ? methodRadio.value : 'email';
                if (method === 'email') manualEmailSection.classList.remove('hidden'); else manualWaSection.classList.remove('hidden');
            }
            updateProgress();
        }

        function updateManualName() {
            const name = document.getElementById('manual-fwd-name').value;
            const display = name.trim() === "" ? "Forwarder" : name;
            document.querySelectorAll('.manual-name-display').forEach(el => { el.innerText = display; });
        }

        function updateProgress() {
            const allBoxes = Array.from(document.querySelectorAll('.task-check'));
            const visibleBoxes = allBoxes.filter(box => { if (box.closest('.hidden')) return false; return true; });
            const total = visibleBoxes.length;
            const checked = visibleBoxes.filter(box => box.checked).length;
            const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
            
            let lastCheckedIndex = -1;
            visibleBoxes.forEach((box, index) => { if (box.checked) lastCheckedIndex = index; });
            visibleBoxes.forEach(box => { const row = box.closest('.step-item'); if (row) row.classList.remove('skipped-item'); });
            
            const skippedNames = [];
            if (lastCheckedIndex !== -1) {
                for (let i = 0; i < lastCheckedIndex; i++) {
                    if (!visibleBoxes[i].checked) {
                        const row = visibleBoxes[i].closest('.step-item');
                        if (row && !visibleBoxes[i].parentElement.classList.contains('sub-checkbox-wrapper')) {
                            row.classList.add('skipped-item');
                            let labelText = "Task";
                            const label = document.querySelector(`label[for="${visibleBoxes[i].id}"]`);
                            if(label) labelText = label.innerText;
                            skippedNames.push(labelText);
                        }
                    }
                }
            }
            
            const statusContainer = document.getElementById('status-text');
            const indicator = statusContainer.querySelector('.status-indicator');
            const statusSpan = statusContainer.querySelector('span:last-child');
            const progressBar = document.getElementById('progress-bar');
            
            progressBar.style.width = percent + '%';
            document.getElementById('progress-percent').innerText = percent + '%';
            
            const donutCircle = document.getElementById('donut-fill');
            const donutNum = document.getElementById('donut-num');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (percent / 100) * circumference;
            donutCircle.style.strokeDashoffset = offset;
            donutNum.innerText = percent + '%';
            
            updatePhaseBar('phase-1', 'p1-bar', 'p1-val');
            updatePhaseBar('phase-2', 'p2-bar', 'p2-val');
            updatePhaseBar('phase-3b', 'p3-bar', 'p3-val');
            updatePhaseBar('phase-4', 'p4-bar', 'p4-val');
            
            let statusText = "Ready to start";
            if (percent === 100) {
                progressBar.classList.add('complete'); progressBar.classList.remove('has-skipped'); indicator.className = 'status-indicator active'; statusSpan.innerHTML = "üéâ Shipment Process Complete!"; statusContainer.style.color = "var(--success)";
                statusText = "üéâ Complete";
            } else if (skippedNames.length > 0) {
                progressBar.classList.remove('complete'); progressBar.classList.add('has-skipped'); indicator.className = 'status-indicator warning';
                let skippedText = skippedNames.length > 1 ? `${skippedNames[0]} (+${skippedNames.length-1})` : skippedNames[0];
                const firstUnchecked = visibleBoxes.find(box => !box.checked);
                let nextStepText = "Done";
                if(firstUnchecked) { const label = document.querySelector(`label[for="${firstUnchecked.id}"]`); if(label) nextStepText = label.innerText; }
                statusSpan.innerHTML = `<span class="text-warning">‚ö†Ô∏è Skipped: ${skippedText}</span> <span style="color:#bdc3c7">|</span> Next: ${nextStepText}`;
                statusContainer.style.color = "var(--primary)";
                statusText = `‚ö†Ô∏è Skipped: ${skippedNames[0]}`;
            } else {
                progressBar.classList.remove('complete'); progressBar.classList.remove('has-skipped'); indicator.className = 'status-indicator active';
                const firstUnchecked = visibleBoxes.find(box => !box.checked);
                if (firstUnchecked) { 
                    const label = document.querySelector(`label[for="${firstUnchecked.id}"]`); 
                    let labelText = label ? label.innerText : "Next Step"; 
                    statusSpan.innerHTML = "Next Step: " + labelText; 
                    statusText = "Next: " + labelText;
                } else { 
                    statusSpan.innerHTML = "Ready to start"; 
                }
                statusContainer.style.color = "var(--primary)";
            }

            // AUTO-SAVE METADATA FOR DASHBOARD
            if (CURRENT_SLOT !== 'ALL') {
                const metaKey = getStoragePrefix() + 'meta';
                const metaData = {
                    percent: percent,
                    status: statusText,
                    lastUpdated: Date.now()
                };
                localStorage.setItem(metaKey, JSON.stringify(metaData));
            }
        }

        function updatePhaseBar(phaseId, barId, valId) {
            const container = document.getElementById(phaseId);
            if (container.classList.contains('hidden')) { document.getElementById(barId).style.width = '0%'; document.getElementById(valId).innerText = 'N/A'; return; }
            const boxes = Array.from(container.querySelectorAll('.task-check'));
            const visibleBoxes = boxes.filter(box => { if (box.closest('.hidden')) return false; return true; });
            if (visibleBoxes.length === 0) { document.getElementById(barId).style.width = '0%'; document.getElementById(valId).innerText = '0%'; return; }
            const checked = visibleBoxes.filter(b => b.checked).length;
            const pct = Math.round((checked / visibleBoxes.length) * 100);
            document.getElementById(barId).style.width = pct + '%'; document.getElementById(valId).innerText = pct + '%';
        }

        function updateCountdown() {
            const dateInput = document.getElementById('inp-date').value;
            const display = document.getElementById('countdown-timer');
            if (!dateInput) { display.innerHTML = "Set Inspection Date"; display.className = "countdown-display"; return; }
            const parts = dateInput.split('-');
            if (parts.length !== 3) { display.innerHTML = "Invalid Date Format"; return; }
            const day = parseInt(parts[0]); const monthStr = parts[1]; const year = parseInt(parts[2]);
            const months = { 'january': 0, 'jan': 0, 'february': 1, 'feb': 1, 'march': 2, 'mar': 2, 'april': 3, 'apr': 3, 'may': 4, 'june': 5, 'jun': 5, 'july': 6, 'jul': 6, 'august': 7, 'aug': 7, 'september': 8, 'sep': 8, 'sept': 8, 'october': 9, 'oct': 9, 'november': 10, 'nov': 10, 'december': 11, 'dec': 11 };
            const monthIndex = months[monthStr.toLowerCase()];
            if (monthIndex === undefined) { display.innerHTML = "Check Month Spelling"; return; }
            const targetDate = new Date(year, monthIndex, day);
            const today = new Date(); today.setHours(0,0,0,0);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) { display.innerHTML = `Inspection Passed (${Math.abs(diffDays)} days ago)`; display.className = "countdown-display"; }
            else if (diffDays === 0) { display.innerHTML = "üö® Inspection is TODAY!"; display.className = "countdown-display urgent"; }
            else if (diffDays <= 3) { display.innerHTML = `‚ö†Ô∏è Only ${diffDays} Days Left!`; display.className = "countdown-display urgent"; }
            else { display.innerHTML = `üìÖ ${diffDays} Days Remaining`; display.className = "countdown-display"; }
        }

        function updateVars() {
            const mapping = { 'inp-date': 'var-date', 'inp-idf': 'var-idf', 'inp-ucr': 'var-ucr', 'inp-proforma': 'var-proforma', 'inp-invoice': 'var-invoice', 'inp-container': 'var-container', 'inp-booking': 'var-booking', 'inp-consignee': 'var-consignee' };
            for (const [inputId, className] of Object.entries(mapping)) {
                const val = document.getElementById(inputId).value;
                if (val.trim() !== "") {
                    document.querySelectorAll('.' + className).forEach(el => {
                        el.innerText = val;
                        el.style.backgroundColor = '#fff9c4';
                        setTimeout(() => { el.style.backgroundColor = '#fffde7'; }, 500);
                    });
                }
            }
        }

        function copyToClipboard(button) {
            var template = button.parentElement;
            var clone = template.cloneNode(true);
            var btnInClone = clone.querySelector('.copy-btn');
            if (btnInClone) btnInClone.remove();
            var text = clone.innerText.trim();

            function handleSuccess() {
                var originalText = "üìã Copy"; 
                if(button.dataset.originalText) originalText = button.dataset.originalText;
                else button.dataset.originalText = button.innerText;

                button.innerText = "Copied!"; 
                button.style.background = "#27ae60"; 
                button.style.color = "white";
                
                setTimeout(function() { 
                    button.innerText = originalText; 
                    button.style.background = "white"; 
                    button.style.color = "#2c3e50"; 
                }, 2000);
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(handleSuccess).catch(function(err) {
                    console.warn('Clipboard API blocked, trying fallback...', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }

            function fallbackCopy(textToCopy) {
                var textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    var successful = document.execCommand('copy');
                    if (successful) {
                        handleSuccess();
                    } else {
                        alert("Clipboard access denied. Please copy manually.");
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert("Clipboard access denied. Please copy manually.");
                }
                document.body.removeChild(textArea);
            }
        }

        function printDeclaration() {
            const date = document.getElementById('inp-date').value || "DATE"; const consignee = document.getElementById('inp-consignee').value || "CONSIGNEE"; const location = document.getElementById('inp-location').value || "LOCATION"; const idf = document.getElementById('inp-idf').value || "IDF"; const ucr = document.getElementById('inp-ucr').value || "UCR"; const pfi = document.getElementById('inp-proforma').value || "PFI"; const container = document.getElementById('inp-container').value || "CONTAINER";
            const content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Declaration</title><style>@media print { body { font-family: Arial; font-size: 12pt; margin-top: 3in; } }</style></head><body style="font-family: Arial; font-size: 12pt; margin-top: 220pt;"><p>${date}</p><br><br><p style="text-align: center; font-weight: bold; text-decoration: underline;">DECLARATION</p><br><p style="text-align: justify;">We undertake that we import used clothing from USA, inspected by SGS Pakistan, export to M/s ${consignee}, ${location} vide IDF# ${idf}, </p><br><p>UCR # ${ucr}<br>PFI# : ${pfi}<br>CNTR# ${container}</p><br><br><br><p style="font-weight: bold;">IDEAS RECYCLING PVT LTD</p></body></html>`;
            const printWindow = window.open('', '', 'height=600,width=800'); printWindow.document.write(content); printWindow.document.close(); printWindow.focus(); printWindow.print();
        }

        function printUndertaking() {
            const date = document.getElementById('inp-date').value || "DATE"; const consignee = document.getElementById('inp-consignee').value || "CONSIGNEE"; const idf = document.getElementById('inp-idf').value || "IDF"; const ucr = document.getElementById('inp-ucr').value || "UCR"; const pfi = document.getElementById('inp-proforma').value || "PFI"; const container = document.getElementById('inp-container').value || "CONTAINER"; const packages = document.getElementById('inp-com-qty').value || "PACKAGES";
            const content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Undertaking Letter</title><style>@media print { body { font-family: Arial; font-size: 12pt; margin-top: 1.5in; } }</style></head><body style="font-family: Arial; font-size: 12pt; margin-top: 100pt;"><p>${date}</p><br><p>TO,<br><strong>SGS PAKISTAN (PRIVATE) LIMITED</strong><br>H-3/3, SECTOR 5, KORANGI INDUSTRIAL AREA,<br>KARACHI-74900, PAKISTAN</p><br><p><strong>SUBJECT: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UNDERTAKING LETTER</strong></p><br><p>We declare that this shipment of Mombasa,</p><ol><li>No package shall contain used undergarments, sleepwear, bath towels, hospital textiles, high visibility garments, handkerchiefs and facemasks.</li><li>Used textile products in the consignment shall be free from prohibited materials such as asbestos mineral wool and erionite.</li><li>For used footwear, no prohibited goods included in the consignment such as Used slippers and ORTHOPEDIC footwear.</li></ol><br><p><strong>IDF#</strong> ${idf},<br><strong>UCR# :</strong> ${ucr}<br><strong>PFI# :</strong> ${pfi}<br><strong>CNTR# :</strong> ${container}<br><strong>IMPORTER:</strong> ${consignee}<br><strong>NO. OF PACKAGES:</strong> ${packages}</p><br><br><p>THANKS & REGARDS</p><br><br><p style="font-weight: bold;">IDEAS RECYCLING PVT LTD,</p></body></html>`;
            const printWindow = window.open('', '', 'height=600,width=800'); printWindow.document.write(content); printWindow.document.close(); printWindow.focus(); printWindow.print();
        }

        function printShoesUndertaking() {
            const date = document.getElementById('inp-date').value || "DATE"; const consignee = document.getElementById('inp-consignee').value || "CONSIGNEE"; const location = document.getElementById('inp-location').value || "LOCATION"; const idf = document.getElementById('inp-idf').value || "IDF"; const ucr = document.getElementById('inp-ucr').value || "UCR"; const pfi = document.getElementById('inp-proforma').value || "PFI"; const container = document.getElementById('inp-container').value || "CONTAINER"; const packages = document.getElementById('inp-com-qty').value || "PACKAGES";
            const content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Shoes Undertaking Letter</title><style>@media print { body { font-family: Arial; font-size: 12pt; margin-top: 1.5in; } }</style></head><body style="font-family: Arial; font-size: 12pt; margin-top: 100pt;"><p>${date}</p><br><p>TO,<br><strong>SGS PAKISTAN (PRIVATE) LIMITED</strong><br>H-3/3, SECTOR 5, KORANGI INDUSTRIAL AREA,<br>KARACHI-74900, PAKISTAN</p><br><p><strong>SUBJECT: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UNDERTAKING LETTER</strong></p><br><p style="text-align: justify;">We declares that this shipment of ${location} has no prohibited items in used shoes such as sandals, used slippers, used indoor footwear. No prohibited goods included in the consignment such as: No consignment shall contain used slippers and orthopedic.</p><br><p><strong>IDF#</strong> ${idf},<br><strong>UCR# :</strong> ${ucr}<br><strong>PFI# :</strong> ${pfi}<br><strong>CNTR# :</strong> ${container}<br><strong>IMPORTER:</strong> ${consignee}<br><strong>NO. OF PACKAGES:</strong> ${packages}</p><br><br><p>THANKS & REGRADS</p><br><br><p style="font-weight: bold;">IDEAS RECYCLING PVT LTD,</p></body></html>`;
            const printWindow = window.open('', '', 'height=600,width=800'); printWindow.document.write(content); printWindow.document.close(); printWindow.focus(); printWindow.print();
        }
    </script>
</body>
</html>